/*
 *  프로그램  : 한틀라이브러리
 *  화일 이름 : HANHANJA.C
 *  만든 이   : 권 재 락
 *  날짜      : 1993. 3. 13
 *  화일 내용 : 한자 입력 처리부
 */

#include <stdio.h>
#include <mem.h>
#include "hanhanja.h"
#include "hanwindw.h"
#include "hanout.h"
#include "ascii.h"
#include "extkey.h"

#define HANJA_P_ROW 8   /* Hanja per row */

unsigned int hanja_table[473][3] = {
  { 34913, 29,    0 }, { 34914, 11,   29 }, { 34917, 24,   40 },
  { 34921, 10,   64 }, { 34929, 20,   74 }, { 34931,  6,   94 },
  { 34935, 24,  100 }, { 34945, 20,  124 }, { 34946,  2,  144 },
  { 34967,  4,  146 }, { 34978,  1,  150 }, { 35041, 17,  151 },
  { 35045, 12,  168 }, { 35049,  4,  180 }, { 35057,  7,  184 },
  { 35059,  3,  191 }, { 35137,  3,  194 }, { 35170,  7,  197 },
  { 35173, 11,  204 }, { 35177,  6,  215 }, { 35185,  6,  221 },
  { 35191, 45,  227 }, { 35201, 24,  272 }, { 35233, 39,  296 },
  { 35234,  7,  335 }, { 35237, 10,  342 }, { 35241,  3,  352 },
  { 35255, 16,  355 }, { 35256,  1,  371 }, { 35265, 12,  372 },
  { 35266,  4,  384 }, { 35269, 17,  388 }, { 35273,  4,  405 },
  { 35287, 13,  409 }, { 35297,  3,  422 }, { 35393,  9,  425 },
  { 35415,  4,  434 }, { 35425, 25,  438 }, { 35457, 54,  463 },
  { 35458,  6,  517 }, { 35461,  6,  523 }, { 35465,  4,  529 },
  { 35479,  6,  533 }, { 35493, 10,  539 }, { 35497,  5,  549 },
  { 35521,  6,  554 }, { 35553,  6,  560 }, { 35649, 15,  566 },
  { 35653,  7,  581 }, { 35657,  1,  588 }, { 35682,  7,  589 },
  { 35685, 15,  596 }, { 35689,  1,  611 }, { 35697, 14,  612 },
  { 35699,  7,  626 }, { 35703,  4,  633 }, { 35745, 64,  637 },
  { 35749,  1,  701 }, { 35753,  4,  702 }, { 35761,  1,  706 },
  { 36770,  1,  707 }, { 36961, 15,  708 }, { 36962,  8,  723 },
  { 36965,  9,  731 }, { 36969,  2,  740 }, { 36977,  9,  742 },
  { 36979,  5,  751 }, { 36983,  7,  756 }, { 36993,  6,  763 },
  { 37015,  1,  769 }, { 37217,  1,  770 }, { 37221,  3,  771 },
  { 37233,  4,  774 }, { 37239,  2,  778 }, { 37281, 18,  780 },
  { 37282,  6,  798 }, { 37285,  1,  804 }, { 37303,  7,  805 },
  { 37441,  6,  812 }, { 37473,  1,  818 }, { 37505,  8,  819 },
  { 37509,  1,  827 }, { 37513,  1,  828 }, { 37697,  2,  829 },
  { 37730,  2,  831 }, { 37745,  1,  833 }, { 37751,  6,  834 },
  { 37793,  2,  840 }, { 37794,  2,  842 }, { 37985,  2,  844 },
  { 37989, 20,  846 }, { 37993,  5,  866 }, { 38001, 17,  871 },
  { 38003,  5,  888 }, { 38007, 11,  893 }, { 38017, 16,  904 },
  { 38018,  1,  920 }, { 38114,  2,  921 }, { 38305, 40,  923 },
  { 38306, 10,  963 }, { 38309, 10,  973 }, { 38313,  2,  983 },
  { 38327, 17,  985 }, { 38529, 11, 1002 }, { 38533,  6, 1013 },
  { 38754,  1, 1019 }, { 38775,  9, 1020 }, { 40033,  9, 1029 },
  { 40034,  9, 1038 }, { 40037,  9, 1047 }, { 40041,  2, 1056 },
  { 40049, 10, 1058 }, { 40051,  3, 1068 }, { 40055,  8, 1071 },
  { 40065,  4, 1079 }, { 40087,  2, 1083 }, { 40098,  1, 1085 },
  { 40119, 13, 1086 }, { 40289, 18, 1099 }, { 40290,  7, 1117 },
  { 40293, 12, 1124 }, { 40297,  6, 1136 }, { 40305,  5, 1142 },
  { 40307,  1, 1147 }, { 40311, 18, 1148 }, { 40321,  5, 1166 },
  { 40353, 18, 1171 }, { 40354,  7, 1189 }, { 40357,  1, 1196 },
  { 40375,  7, 1197 }, { 40513,  8, 1204 }, { 40545, 12, 1212 },
  { 40567,  1, 1224 }, { 40577, 13, 1225 }, { 40769, 14, 1238 },
  { 40770,  3, 1252 }, { 40773,  6, 1255 }, { 40777,  4, 1261 },
  { 40791,  1, 1265 }, { 40802,  2, 1266 }, { 40817,  1, 1268 },
  { 40823,  6, 1269 }, { 40865, 26, 1275 }, { 40869,  9, 1301 },
  { 40881,  5, 1310 }, { 40883,  4, 1315 }, { 41057,  8, 1319 },
  { 41058,  6, 1327 }, { 41061, 19, 1333 }, { 41065,  7, 1352 },
  { 41079, 12, 1359 }, { 41089, 14, 1371 }, { 41090,  5, 1385 },
  { 41111,  6, 1390 }, { 41314,  2, 1396 }, { 41317, 11, 1398 },
  { 41321,  2, 1409 }, { 41335, 15, 1411 }, { 41345,  1, 1426 },
  { 41377, 24, 1427 }, { 41378,  7, 1451 }, { 41385,  2, 1458 },
  { 41399,  3, 1460 }, { 41569, 12, 1463 }, { 41601, 22, 1475 },
  { 41602,  2, 1497 }, { 41605, 12, 1499 }, { 41609,  3, 1511 },
  { 41889, 19, 1514 }, { 41893, 13, 1533 }, { 41897,  3, 1546 },
  { 42082, 19, 1549 }, { 42085, 25, 1568 }, { 42089, 11, 1593 },
  { 42103, 28, 1604 }, { 42113, 20, 1632 }, { 42114,  8, 1652 },
  { 42213, 10, 1660 }, { 42217,  4, 1670 }, { 42225,  9, 1674 },
  { 42227,  2, 1683 }, { 42338, 11, 1685 }, { 42341,  7, 1696 },
  { 42345,  4, 1703 }, { 42359, 17, 1707 }, { 42401, 16, 1724 },
  { 42402, 17, 1740 }, { 42405,  1, 1757 }, { 42409,  1, 1758 },
  { 42423, 16, 1759 }, { 42625, 43, 1775 }, { 42626,  1, 1818 },
  { 42629, 19, 1819 }, { 42633,  5, 1838 }, { 42647,  6, 1843 },
  { 42913, 43, 1849 }, { 42917, 14, 1892 }, { 42935,  4, 1906 },
  { 44129, 60, 1910 }, { 44130,  4, 1970 }, { 44133, 12, 1974 },
  { 44137,  5, 1986 }, { 44145,  8, 1991 }, { 44147,  4, 1999 },
  { 44151, 31, 2003 }, { 44161,  3, 2034 }, { 44162,  5, 2037 },
  { 44183,  5, 2042 }, { 44257, 30, 2047 }, { 44258, 15, 2077 },
  { 44261, 32, 2092 }, { 44265, 13, 2124 }, { 44273,  8, 2137 },
  { 44275,  4, 2145 }, { 44279, 18, 2149 }, { 44353,  9, 2167 },
  { 44449, 37, 2176 }, { 44450,  9, 2213 }, { 44453,  6, 2222 },
  { 44457,  1, 2228 }, { 44471,  8, 2229 }, { 44513,  5, 2237 },
  { 44609,  2, 2242 }, { 44673, 61, 2244 }, { 44674, 12, 2305 },
  { 44677, 27, 2317 }, { 44681,  4, 2344 }, { 44695,  3, 2348 },
  { 44905,  6, 2351 }, { 44915,  5, 2354 }, { 44919, 10, 2359 },
  { 44961, 28, 2369 }, { 44962, 15, 2397 }, { 44965, 24, 2412 },
  { 44969,  4, 2436 }, { 44977, 10, 2440 }, { 44979,  3, 2450 },
  { 45175,  1, 2453 }, { 45985,  1, 2454 }, { 46177, 18, 2455 },
  { 46178, 14, 2473 }, { 46181, 10, 2487 }, { 46185,  4, 2497 },
  { 46193,  8, 2501 }, { 46195,  4, 2509 }, { 46199,  7, 2513 },
  { 46209, 11, 2520 }, { 46210,  7, 2531 }, { 46231,  4, 2538 },
  { 46241, 11, 2542 }, { 46242,  9, 2553 }, { 46263, 31, 2562 },
  { 46305, 10, 2593 }, { 46306,  5, 2603 }, { 46309,  6, 2608 },
  { 46313,  2, 2614 }, { 46321,  6, 2616 }, { 46323,  2, 2622 },
  { 46405,  1, 2624 }, { 46433, 24, 2625 }, { 46434, 13, 2649 },
  { 46437, 43, 2662 }, { 46441, 10, 2705 }, { 46449, 15, 2715 },
  { 46451,  4, 2730 }, { 46455, 40, 2734 }, { 46465, 24, 2774 },
  { 46497, 30, 2798 }, { 46498,  5, 2828 }, { 46501,  6, 2833 },
  { 46505,  1, 2839 }, { 46519,  9, 2840 }, { 46529,  8, 2849 },
  { 46533, 18, 2857 }, { 46537,  1, 2875 }, { 46551,  5, 2876 },
  { 46561,  4, 2881 }, { 46657,  5, 2885 }, { 46689, 38, 2890 },
  { 46690,  6, 2928 }, { 46711, 24, 2934 }, { 46721, 32, 2958 },
  { 46722,  9, 2990 }, { 46725, 13, 2999 }, { 46729,  3, 3012 },
  { 46743,  2, 3015 }, { 46757, 27, 3017 }, { 46761,  3, 3044 },
  { 46817, 25, 3047 }, { 46913, 56, 3072 }, { 46914,  7, 3128 },
  { 46917, 13, 3135 }, { 46921,  5, 3148 }, { 46935,  5, 3153 },
  { 46949,  7, 3158 }, { 46953,  1, 3165 }, { 46961,  6, 3166 },
  { 46963,  3, 3172 }, { 46967,  4, 3175 }, { 46977, 19, 3179 },
  { 47009, 38, 3198 }, { 47010,  8, 3236 }, { 47013, 24, 3244 },
  { 47017,  9, 3268 }, { 47025, 11, 3277 }, { 47027,  5, 3288 },
  { 47031,  4, 3293 }, { 47201, 26, 3297 }, { 47202, 13, 3323 },
  { 47205,  5, 3336 }, { 47217,  6, 3341 }, { 47219,  1, 3347 },
  { 47223, 37, 3348 }, { 47233, 17, 3385 }, { 47255,  4, 3402 },
  { 47329, 28, 3406 }, { 47330, 25, 3434 }, { 47333, 41, 3459 },
  { 47337,  8, 3500 }, { 47345,  9, 3508 }, { 47347,  3, 3517 },
  { 47351, 55, 3520 }, { 47425, 23, 3575 }, { 47521, 46, 3598 },
  { 47522,  4, 3644 }, { 47525,  2, 3648 }, { 47529,  3, 3650 },
  { 47543, 17, 3653 }, { 47553,  5, 3670 }, { 47681,  1, 3675 },
  { 47745, 40, 3676 }, { 47746,  2, 3716 }, { 47749, 19, 3718 },
  { 47753,  1, 3737 }, { 47767,  4, 3738 }, { 47970,  1, 3742 },
  { 47977,  1, 3743 }, { 47987,  3, 3744 }, { 47991, 11, 3747 },
  { 48033, 34, 3758 }, { 48034,  5, 3792 }, { 48037, 35, 3797 },
  { 48041, 15, 3832 }, { 48049,  2, 3847 }, { 48051,  7, 3849 },
  { 48055,  3, 3856 }, { 49249, 15, 3859 }, { 49250,  7, 3874 },
  { 49253, 15, 3881 }, { 49257,  5, 3896 }, { 49265, 10, 3901 },
  { 49271, 22, 3911 }, { 49281, 12, 3933 }, { 49282,  4, 3945 },
  { 49377,  4, 3949 }, { 49378, 15, 3953 }, { 49381, 19, 3968 },
  { 49385, 10, 3987 }, { 49393, 10, 3997 }, { 49395, 10, 4007 },
  { 49399,  8, 4017 }, { 49473, 10, 4025 }, { 49569, 27, 4035 },
  { 49570,  6, 4062 }, { 49573,  3, 4068 }, { 49591, 11, 4071 },
  { 49609,  1, 4082 }, { 49729,  3, 4083 }, { 49793, 23, 4086 },
  { 49794, 12, 4109 }, { 49797,  3, 4121 }, { 49801,  3, 4124 },
  { 49815,  6, 4127 }, { 49857,  3, 4133 }, { 49889, 15, 4136 },
  { 50018,  5, 4151 }, { 50039,  1, 4156 }, { 50081, 24, 4157 },
  { 50082,  3, 4181 }, { 50085,  1, 4184 }, { 50089,  3, 4185 },
  { 50097,  9, 4188 }, { 50099,  1, 4197 }, { 50103,  2, 4198 },
  { 50657,  1, 4200 }, { 51297, 14, 4201 }, { 51298, 16, 4215 },
  { 51301, 10, 4231 }, { 51305,  2, 4241 }, { 51313,  4, 4243 },
  { 51315,  3, 4247 }, { 51319,  5, 4250 }, { 51329, 14, 4255 },
  { 51330,  3, 4269 }, { 51351,  1, 4272 }, { 51425,  1, 4273 },
  { 51617,  4, 4274 }, { 51639,  7, 4278 }, { 51777,  6, 4285 },
  { 51841,  6, 4291 }, { 52066,  2, 4297 }, { 52081,  1, 4299 },
  { 52321, 16, 4300 }, { 52325,  9, 4316 }, { 52329,  3, 4325 },
  { 52353, 11, 4328 }, { 52375,  4, 4339 }, { 52386,  1, 4343 },
  { 52581, 10, 4344 }, { 52593,  1, 4354 }, { 52599,  5, 4355 },
  { 52609, 10, 4360 }, { 52641, 28, 4370 }, { 52642,  6, 4398 },
  { 52833, 14, 4404 }, { 52881,  2, 4418 }, { 52887,  5, 4420 },
  { 53153,  7, 4425 }, { 53161, 10, 4432 }, { 53171,  2, 4442 },
  { 53345, 14, 4444 }, { 53346,  5, 4458 }, { 53349, 14, 4463 },
  { 53353,  2, 4477 }, { 53361, 12, 4479 }, { 53363,  7, 4491 },
  { 53367, 17, 4498 }, { 53377, 18, 4515 }, { 53378,  2, 4533 },
  { 53399,  5, 4535 }, { 53431,  9, 4540 }, { 53473,  4, 4549 },
  { 53477,  4, 4553 }, { 53481,  1, 4557 }, { 53489,  2, 4558 },
  { 53602,  4, 4560 }, { 53605, 21, 4564 }, { 53609,  4, 4585 },
  { 53617,  1, 4589 }, { 53619, 12, 4590 }, { 53623, 20, 4602 },
  { 53633,  9, 4622 }, { 53665, 41, 4631 }, { 53666,  3, 4672 },
  { 53669,  6, 4675 }, { 53673,  3, 4681 }, { 53687, 10, 4684 },
  { 53697, 14, 4694 }, { 53698,  6, 4708 }, { 53701, 17, 4714 },
  { 53705,  5, 4731 }, { 53719, 24, 4736 }, { 53825, 20, 4760 },
  { 53826,  2, 4780 }, { 53847,  3, 4782 }, { 53857, 13, 4785 },
  { 53889, 13, 4798 }, { 53893, 10, 4811 }, { 53911,  1, 4821 },
  { 53925,  4, 4822 }, { 53953,  3, 4826 }, { 53985,  8, 4829 },
  { 54081,  5, 4837 }, { 54089,  3, 4842 }, { 54103,  5, 4845 },
  { 54114,  1, 4850 }, { 54117,  4, 4851 }, { 54121,  4, 4855 },
  { 54129,  3, 4859 }, { 54131,  4, 4862 }, { 54135,  1, 4866 },
  { 54145, 20, 4867 }, { 54185,  1, 4887 }
};

/* 한글코드를 주면 그 한글코드에 해당하는 한자가 존재하는지를
   한자표에서 찾아서 존재하면 그 번호(몇번째 위치인가)를 돌려주고,
   없다면 -1을 돌려준다. */

static int hanja_b_search(unsigned hangul_code)
{
  unsigned low, mid, high, success;

  low = 0, high = 472, success = 0;
  while(low <= high) {
    mid = (high+low)/2;
    if(hanja_table[mid][0] == hangul_code) {
      success = 1;
      break;
    }
    else if(hanja_table[mid][0] > hangul_code)
      high = mid-1;
    else
      low = mid+1;
  }
  return success ? mid : -1;
}

/* 한자코드 상의 위치(n), 즉 몇번째 한자냐, 실제 한자코드를 만들어 냄 */
static unsigned get_hanja_code(int n)
{
  unsigned char hi, lo;
  /* 188 = 78 + 110 */
  hi = n/188+0xE0;
  lo = n%188;
  if(lo < 78)
    lo += 0x31;
  else
    lo += 67; /* 67 = 0x91 - 78 */
  return(hi*256+lo);
}

/* 화면에서 한자 고르기 */
static char hanja_select(unsigned int hangul_code, int maxnum, int index)
{
  int key_code, quit, col_off, row_off, row_end, col_end, ret;
  unsigned int hanja_code;
  bool onoff;

  /* row_off는 한자 선택화면에서 한자의 행의 상대 위치,
     col_off는 열의 위치의 상대 위치, col_off가 1인 이유는
     한자 선택표의 가장 처음 글자는 그 글자의 한글이기 때문이다. */
  quit = row_off = 0, col_off = 1;
  row_end = maxnum / HANJA_P_ROW;
  col_end = maxnum % HANJA_P_ROW;
  do {
    onoff = isreverse();
    if(!onoff)
      hsetreverse(ON);
    if(col_off == 0 && row_off == 0)
      _hputchxy((hangul_code >> 8) & 0x00FF, hangul_code & 0x00FF, 3, 1);
    else {
      hanja_code = get_hanja_code(index+row_off*HANJA_P_ROW+col_off-1);
      _hputchxy((hanja_code >> 8) & 0x00FF, hanja_code & 0x00FF, col_off*3+3, row_off+1);
    }
    key_code = getxch();
    hsetreverse(onoff);
    if(col_off == 0 && row_off == 0)
      _hputchxy((hangul_code >> 8) & 0x00FF, hangul_code & 0x00FF, 3, 1);
    else
      _hputchxy((hanja_code >> 8) & 0x00FF, hanja_code & 0x00FF, col_off*3+3, row_off+1);
    switch(key_code) {
      case ESC :
        ret = -1, quit = 1;
        break;
      case '\r' :
        ret = (col_off==0 && row_off==0) ? -1 : col_off+row_off*HANJA_P_ROW;
        quit = 1;
        break;
      case PGUPKEY :
        col_off = 1, row_off = 0;
        break;
      case PGDNKEY :
        col_off = col_end, row_off = row_end;
        break;
      case LEFTARROW:
        if(col_off == 0) {
          if(row_off != 0)
            row_off--, col_off = HANJA_P_ROW-1;
        } else
          col_off--;
        break;
      case RIGHTARROW :
        if((col_off != col_end) || (row_off != row_end)) {
          if(col_off == HANJA_P_ROW-1)
            col_off  = 0, row_off++;
          else
            col_off++;
        }
        break;
      case UPARROW  :
        if(row_off != 0)
          row_off--;
        break;
      case DOWNARROW :
        if(row_off != row_end) {
          if(row_off == row_end-1) {
            if(col_off <= col_end)
              row_off++;
            else
              row_off = row_end-1;
          } else
            row_off++;
        }
        break;
      case HOMEKEY :
        col_off = 0;
        break;
      case ENDKEY :
        if(row_off == row_end)
          col_off = col_end;
        else
          col_off = HANJA_P_ROW-1;
        break;
    } /* switch for key_code */
  } while(!quit);
  return ret;
}

/* 삼보 한자코드 4888자 지원 */
unsigned findhanja(int x, int y, unsigned char hcode1, unsigned char hcode2)
{
  unsigned ret;
  int index, cnt, order, sy;
  unsigned int hangul_code, hanja_code;
  register i;

  hangul_code = (hcode1 << 8) + hcode2;
  order = ret = -1, sy = 0;
  index = hanja_b_search(hangul_code);
  if(index != -1) { /* 그런 한자가 있다 */
    if(!wopen(x, y, 27, 11))
      return hangul_code;
    wtitle("◈ 한 자 사 전 ◈");
    _hputchxy(hcode1, hcode2, 3, 1);
    for(cnt = 1, i = 1; i < hanja_table[index][1]+1; i++) {
      hanja_code = get_hanja_code(i+hanja_table[index][2]-1);
      _hputchxy((hanja_code >> 8) & 0x00FF, hanja_code & 0x00FF, 3+cnt*3, 1+sy);
      if(cnt < HANJA_P_ROW-1)
        cnt++;
      else
        cnt = 0,  sy++;
    }
    order = hanja_select(hanja_table[index][0], hanja_table[index][1], hanja_table[index][2]);
    wclose();
    if(order != -1 && order != 0)
      ret = get_hanja_code(order+hanja_table[index][2]-1);
  } /* if for index */
  return (index != -1 && order != -1) ? ret : hangul_code;
}

/* HANHANJA.C의 화일 끝 */

